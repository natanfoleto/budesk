generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ENUMS

enum UserRole {
  ROOT
  ADMIN
  EMPLOYEE
}

enum TransactionType {
  ENTRADA
  SAIDA
}

enum PaymentMethod {
  DINHEIRO
  PIX
  CARTAO
  BOLETO
  CHEQUE
  TRANSFERENCIA
}

enum AccountStatus {
  PENDENTE
  PAGA
  ATRASADA
}

enum ServiceStatus {
  ABERTO
  EM_ANDAMENTO
  FINALIZADO
  CANCELADO
}

enum VehicleType {
  CARRO
  UTILITARIO
  CAMINHONETE
  VAN
  SUV
  MOTO
  ONIBUS
  MICRO_ONIBUS
  CAMINHAO
  CAMINHAO_3_4
  CAMINHAO_TOCO
  CAMINHAO_TRUCK
  CARRETA
  BITREM
  RODOTREM
  MAQUINA
  TRATOR
  RETROESCAVADEIRA
  PA_CARREGADEIRA
  ESCAVADEIRA
  MOTONIVELADORA
  ROLO_COMPACTADOR
  REBOQUE
  SEMIRREBOQUE
  PRANCHA
  TANQUE
  COLHEITADEIRA
  PULVERIZADOR
  EMPILHADEIRA
  OUTRO
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
}

enum ShirtSize {
  P
  M
  G
  GG
  XGG
}

enum ContractStatus {
  ACTIVE
  FINISHED
  TERMINATED
}

enum RHPaymentStatus {
  SIMULADO
  PENDENTE
  PAGO
  CANCELADO
}

enum RHPaymentType {
  SALARIO
  DIARIA
  COMISSAO
  BONUS
  RESCISAO
  FERIAS
  DECIMO_TERCEIRO
}

enum VacationStatus {
  PREVISTA
  APROVADA
  GOZADA
  PAGA
}

enum ThirteenthStatus {
  PENDENTE
  PARCIAL
  PAGO
}

enum AttendanceType {
  PRESENCA
  FALTA
  FALTA_JUSTIFICADA
  ATESTADO
}

// USUÁRIOS

model User {
  id        String   @id @default(cuid())
  name      String   @db.VarChar(255)
  email     String   @unique
  password  String
  role      UserRole
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  services  Service[]
  auditLogs AuditLog[]
  loginLogs LoginLog[]

  @@map("users")
}

// AUDITORIA GLOBAL

model AuditLog {
  id        String      @id @default(cuid())
  userId    String?
  action    AuditAction
  entity    String
  entityId  String?
  oldData   Json?
  newData   Json?
  ip        String?
  userAgent String?
  createdAt DateTime    @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([entity])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// LOGIN LOG

model LoginLog {
  id        String   @id @default(cuid())
  userId    String?
  email     String
  success   Boolean
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([createdAt])
  @@map("login_logs")
}

// CLIENTES

model Client {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?
  document  String? // CPF/CNPJ
  address   String?
  createdAt DateTime @default(now())

  services Service[]
  documents Document[]

  @@map("clients")
}

// FORNECEDORES

model Supplier {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?
  document  String? // CNPJ/CPF
  address   String?
  category  String?
  createdAt DateTime @default(now())

  transactions FinancialTransaction[]
  accounts     AccountPayable[]
  maintenances Maintenance[]

  @@map("suppliers")
}

// FUNCIONÁRIOS

model Employee {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String?
  document  String?  @unique // CPF
  rg        String?
  birthDate DateTime?
  gender    String?
  shirtSize ShirtSize?
  pantsSize String?
  shoeSize  String?
  role          String?
  salaryInCents Int      @map("salary_in_cents")
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  standardEntryTime String? // "08:00"
  standardExitTime  String? // "17:00"

  advances          EmployeeAdvance[]
  transactions      FinancialTransaction[]
  employmentRecords EmploymentRecord[]
  contracts         EmployeeContract[]


  // RH Relations
  rhPayments        RHPayment[]
  salaryHistories   SalaryHistory[]
  vacations         Vacation[]
  thirteenthSalaries ThirteenthSalary[]
  timeBank          TimeBank?
  attendanceRecords AttendanceRecord[]

  @@map("employees")
}

model EmployeeAdvance {
  id         String   @id @default(cuid())
  employeeId String
  amount     Decimal  @db.Decimal(10, 2)
  date       DateTime
  note       String?
  payrollReference String?
  transactionId    String? @unique

  transaction FinancialTransaction? @relation(fields: [transactionId], references: [id])
  employee    Employee              @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@map("employee_advances")
}

model EmploymentRecord {
  id              String    @id @default(cuid())
  employeeId      String
  admissionDate   DateTime
  terminationDate DateTime?
  jobTitle        String
  baseSalary      Decimal   @db.Decimal(10, 2)
  contractType    String
  weeklyWorkload  Int?
  workRegime      String?
  isActive        Boolean   @default(true)
  hasMedicalExam        Boolean   @default(false)
  hasSignedRegistration Boolean   @default(false)
  hasSignedEpiReceipt   Boolean   @default(false)
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  employee        Employee  @relation(fields: [employeeId], references: [id])

  @@map("employment_records")
}

model EmployeeContract {
  id            String         @id @default(cuid())
  employeeId    String
  type          String
  startDate     DateTime
  endDate       DateTime?
  valueInCents  Int            @map("value_in_cents")
  status        ContractStatus @default(ACTIVE)
  description   String?
  fileUrl       String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  employee      Employee       @relation(fields: [employeeId], references: [id])

  @@map("employee_contracts")
}


// SERVIÇOS

model Service {
  id          String        @id @default(cuid())
  title       String
  description String?
  status      ServiceStatus
  startDate   DateTime
  endDate     DateTime?
  clientId    String?
  createdById String
  createdAt   DateTime      @default(now())

  client       Client?                @relation(fields: [clientId], references: [id])
  createdBy    User                   @relation(fields: [createdById], references: [id])
  transactions FinancialTransaction[]
  documents    Document[]
  vehicleUsage VehicleUsage[]

  @@index([status])
  @@index([startDate])
  @@map("services")
}

// FINANCEIRO / CAIXA

model FinancialTransaction {
  id            String          @id @default(cuid())
  description   String
  type          TransactionType
  valueInCents  Int             @map("value_in_cents")
  category      String
  paymentMethod PaymentMethod
  date          DateTime
  serviceId     String?
  employeeId    String?
  supplierId    String?
  createdAt     DateTime        @default(now())

  service  Service?  @relation(fields: [serviceId], references: [id])
  employee Employee? @relation(fields: [employeeId], references: [id])
  supplier Supplier? @relation(fields: [supplierId], references: [id])
  advance  EmployeeAdvance?
  maintenanceId String? @unique
  maintenance   Maintenance? @relation(fields: [maintenanceId], references: [id])
  rhPaymentId   String?  @unique
  rhPayment     RHPayment? @relation(fields: [rhPaymentId], references: [id])

  @@index([type])
  @@index([date])
  @@index([category])
  @@map("financial_transactions")
}

// CONTAS A PAGAR

model AccountPayable {
  id           String        @id @default(cuid())
  description  String
  valueInCents Int           @map("value_in_cents")
  dueDate      DateTime
  status       AccountStatus
  supplierId  String?
  createdAt   DateTime      @default(now())

  supplier Supplier? @relation(fields: [supplierId], references: [id])

  @@index([dueDate])
  @@index([status])
  @@map("accounts_payable")
}

// DOCUMENTOS

model Document {
  id        String   @id @default(cuid())
  name      String
  category  String?
  fileUrl   String
  description String?
  serviceId String?
  clientId  String?
  vehicleId String?
  createdAt DateTime @default(now())

  service Service? @relation(fields: [serviceId], references: [id])
  client  Client?  @relation(fields: [clientId], references: [id]) 
  vehicle Vehicle? @relation(fields: [vehicleId], references: [id])

  @@index([category])
  @@map("documents")
}

// FROTA

model Vehicle {
  id          String      @id @default(cuid())
  plate       String
  model       String?
  brand       String?
  year        Int?
  description String?
  type        VehicleType
  active      Boolean     @default(true)
  createdAt   DateTime    @default(now())

  usages VehicleUsage[]
  documents Document[]
  maintenances Maintenance[]

  @@unique([plate])
  @@map("vehicles")
}

model VehicleUsage {
  id        String  @id @default(cuid())
  vehicleId String
  serviceId String
  cost      Decimal @db.Decimal(10, 2)
  note      String?

  vehicle Vehicle @relation(fields: [vehicleId], references: [id])
  service Service @relation(fields: [serviceId], references: [id])

  @@index([vehicleId])
  @@index([serviceId])
  @@map("vehicle_usages")
}

// MANUTENÇÃO

enum MaintenanceType {
  PREVENTIVA
  CORRETIVA
  PREDITIVA
}

enum MaintenanceStatus {
  PENDENTE
  AGENDADA
  REALIZADA
  CANCELADA
}

enum MaintenancePriority {
  BAIXA
  MEDIA
  ALTA
}

model Maintenance {
  id          String   @id @default(cuid())
  vehicleId   String
  type        MaintenanceType
  category    String   // e.g. "Troca de óleo"
  description String
  priority    MaintenancePriority
  
  // Dates & KM
  scheduledDate      DateTime
  completedDate      DateTime?
  currentKm          Int?
  nextKm             Int?
  nextDate           DateTime?
  isRecurrent        Boolean @default(false)
  intervalKm         Int?
  intervalDays       Int?
  
  // Helper
  active             Boolean @default(true) // For soft delete/archiving

  // Financial
  estimatedCost      Int     // in cents
  finalCost          Int?    // in cents
  costCenter         String?
  supplierId         String?
  invoiceNumber      String?

  // Status
  status             MaintenanceStatus @default(PENDENTE)
  isPaid             Boolean @default(false)

  // Extras
  internalNotes      String?
  attachments        Json?
  approvalResponsible String?
  downtimeDays       Int?
  operationalImpact  String? // Could be enum or string "BAIXO", "MEDIO", "ALTO"

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  vehicle            Vehicle @relation(fields: [vehicleId], references: [id])
  supplier           Supplier? @relation(fields: [supplierId], references: [id])
  transaction        FinancialTransaction? // 1:1 reverse relation ideally, or 1:N

  @@map("maintenances")
}

// RH — RECURSOS HUMANOS

model RHPayment {
  id                  String          @id @default(cuid())
  employeeId          String
  competencia         String          // "YYYY-MM" format
  tipoPagamento       RHPaymentType
  salarioBase         Decimal         @db.Decimal(10, 2)
  adicionais          Decimal         @default(0) @db.Decimal(10, 2)
  horasExtras         Decimal         @default(0) @db.Decimal(4, 2)
  valorHorasExtras    Decimal         @default(0) @db.Decimal(10, 2)
  descontos           Decimal         @default(0) @db.Decimal(10, 2)
  valorAdiantamentos  Decimal         @default(0) @db.Decimal(10, 2)
  totalBruto          Decimal         @db.Decimal(10, 2)
  totalLiquido        Decimal         @db.Decimal(10, 2)
  status              RHPaymentStatus @default(PENDENTE)
  dataPagamento       DateTime?
  formaPagamento      PaymentMethod?
  centroCusto         String?
  observacoes         String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  employee            Employee        @relation(fields: [employeeId], references: [id])
  transaction         FinancialTransaction?
  encargos            EmployerContribution?
  rateios             ProjectAllocation[]

  @@index([employeeId])
  @@index([competencia])
  @@index([status])
  @@map("rh_payments")
}

model SalaryHistory {
  id                String   @id @default(cuid())
  employeeId        String
  salarioAnterior   Decimal  @db.Decimal(10, 2)
  novoSalario       Decimal  @db.Decimal(10, 2)
  percentualAumento Decimal  @db.Decimal(5, 2)
  motivo            String?
  dataVigencia      DateTime
  createdAt         DateTime @default(now())

  employee          Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@map("salary_histories")
}

model Vacation {
  id                     String        @id @default(cuid())
  employeeId             String
  periodoAquisitivoInicio DateTime
  periodoAquisitivoFim   DateTime
  diasDireito            Int           @default(30)
  diasUtilizados         Int           @default(0)
  dataInicio             DateTime?
  dataFim                DateTime?
  valorFerias            Decimal?      @db.Decimal(10, 2)
  adicionalUmTerco       Decimal?      @db.Decimal(10, 2)
  status                 VacationStatus @default(PREVISTA)
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  employee               Employee      @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@map("vacations")
}

model ThirteenthSalary {
  id              String           @id @default(cuid())
  employeeId      String
  anoReferencia   Int
  mesesTrabalhados Int
  valorTotal      Decimal          @db.Decimal(10, 2)
  primeiraParcela Decimal?         @db.Decimal(10, 2)
  segundaParcela  Decimal?         @db.Decimal(10, 2)
  primeiraPaga    Boolean          @default(false)
  segundaPaga     Boolean          @default(false)
  status          ThirteenthStatus @default(PENDENTE)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  employee        Employee         @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, anoReferencia])
  @@index([employeeId])
  @@map("thirteenth_salaries")
}

model TimeBank {
  id           String   @id @default(cuid())
  employeeId   String   @unique
  saldoHoras   Decimal  @default(0) @db.Decimal(6, 2)
  horasCredito Decimal  @default(0) @db.Decimal(6, 2)
  horasDebito  Decimal  @default(0) @db.Decimal(6, 2)
  updatedAt    DateTime @updatedAt

  employee     Employee @relation(fields: [employeeId], references: [id])

  @@map("time_bank")
}

model AttendanceRecord {
  id              String         @id @default(cuid())
  employeeId      String
  data            DateTime       @db.Date
  tipo            AttendanceType
  horasTrabalhadas Decimal?      @db.Decimal(4, 2)
  horasExtras     Decimal?       @db.Decimal(4, 2)
  bancoHorasImpacto Decimal?     @db.Decimal(4, 2)
  observacao      String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  employee        Employee       @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, data])
  @@index([employeeId])
  @@index([data])
  @@map("attendance_records")
}

model EmployerContribution {
  id                  String    @id @default(cuid())
  pagamentoId         String    @unique
  inssEmpresa         Decimal   @default(0) @db.Decimal(10, 2)
  fgts                Decimal   @default(0) @db.Decimal(10, 2)
  outrosEncargos      Decimal   @default(0) @db.Decimal(10, 2)
  totalEncargosEmpresa Decimal  @db.Decimal(10, 2)
  transactionId       String?   @unique
  createdAt           DateTime  @default(now())

  pagamento           RHPayment @relation(fields: [pagamentoId], references: [id], onDelete: Cascade)

  @@map("employer_contributions")
}

model ProjectAllocation {
  id              String    @id @default(cuid())
  pagamentoId     String
  projetoId       String
  percentualRateio Decimal  @db.Decimal(5, 2)
  valorRateado    Decimal   @db.Decimal(10, 2)
  createdAt       DateTime  @default(now())

  pagamento       RHPayment @relation(fields: [pagamentoId], references: [id], onDelete: Cascade)

  @@index([pagamentoId])
  @@map("project_allocations")
}
